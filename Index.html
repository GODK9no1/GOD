<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Prompt', sans-serif; 
      background: linear-gradient(135deg, #75dbf0 0%, #a7bfe8 100%);
      margin: 0; 
      min-height: 100vh;
      padding-bottom: 20px;
    }
    .container { 
      max-width: 900px; 
      margin: 20px auto; 
      background: #fff; 
      border-radius: 18px; 
      box-shadow: 0 6px 24px #72bada99; 
      padding: 28px;
    }
    h2 { 
      text-align: center; 
      color: #3474bb; 
      margin: 0 0 20px 0;
      font-size: 1.8em;
    }
    .header-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    .stats-box {
      background: linear-gradient(135deg, #51b7f9 0%, #3faee4 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
      box-shadow: 0 4px 12px rgba(51, 183, 249, 0.3);
    }
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .stat-number {
      font-size: 1.8em;
      font-weight: bold;
    }
    .stat-label {
      font-size: 0.9em;
      opacity: 0.9;
    }
    .add-row { 
      display: flex; 
      gap: 8px; 
      margin-bottom: 14px;
      flex-wrap: wrap;
    }
    .add-row input { 
      flex: 1; 
      min-width: 150px;
      border-radius: 8px; 
      border: 1px solid #bcd4dc; 
      padding: 10px; 
      font-size: 1em;
    }
    .add-row button { 
      border: none; 
      background: #14cb99; 
      color: #fff; 
      border-radius: 8px; 
      padding: 10px 20px; 
      font-size: 1em; 
      cursor: pointer; 
      transition: all 0.15s;
      font-weight: 600;
    }
    .add-row button:hover { 
      background: #117a6a;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(20, 203, 153, 0.3);
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .action-buttons button {
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95em;
      font-weight: 600;
      transition: all 0.15s;
      color: white;
    }
    .btn-export {
      background: #3faee4;
    }
    .btn-export:hover {
      background: #2a8cb3;
      transform: translateY(-2px);
    }
    .btn-import {
      background: #9a57d3;
    }
    .btn-import:hover {
      background: #7a3fa3;
      transform: translateY(-2px);
    }
    .btn-backup {
      background: #ff8800;
    }
    .btn-backup:hover {
      background: #cc6600;
      transform: translateY(-2px);
    }
    .btn-reset {
      background: #e05c4b;
    }
    .btn-reset:hover {
      background: #b82013;
      transform: translateY(-2px);
    }
    .date-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .date-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .date-row select { 
      font-size: 1em; 
      border-radius: 6px; 
      border: 1px solid #aacde7; 
      padding: 8px;
      min-width: 140px;
    }
    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 180px;
    }
    .search-box input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #bcd4dc;
      border-radius: 6px;
      font-size: 0.95em;
    }
    .table-wrapper {
      overflow-x: auto;
      margin-bottom: 20px;
    }
    table { 
      border-collapse: collapse; 
      width: 100%; 
      background: #fff; 
      border-radius: 12px; 
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td { 
      padding: 12px 8px; 
      text-align: center;
      border-bottom: 1px solid #e0e8f0;
    }
    th { 
      background: #51b7f9; 
      color: #fff; 
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    tr:nth-child(even) td { 
      background: #f4fafd;
    }
    tr:hover td {
      background-color: #e8f4fb !important;
    }
    td.status-radio input[type="radio"] { 
      accent-color: #0db3c6;
      cursor: pointer;
      width: 18px;
      height: 18px;
    }
    .on-time { 
      color: #119600; 
      font-weight: bold;
    }
    .late { 
      color: #ff8800; 
      font-weight: bold;
    }
    .leave { 
      color: #db8413; 
      font-weight: bold;
    }
    .sick { 
      color: #9a57d3; 
      font-weight: bold;
    }
    .not-checked {
      color: #999;
      font-weight: 500;
    }
    .btn-del { 
      background: #e05c4b; 
      color: #fff; 
      border: none; 
      border-radius: 8px; 
      padding: 6px 12px; 
      font-size: 0.95em; 
      cursor: pointer;
      transition: all 0.15s;
      font-weight: 600;
    }
    .btn-del:hover { 
      background: #b82013;
      transform: scale(1.05);
    }
    .history-block {
      background: linear-gradient(135deg, #ecf6fa 0%, #e0f0f7 100%);
      border-radius: 12px; 
      padding: 15px; 
      margin-top: 20px;
      border: 1px solid #c5e3f0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .history-block h4 {
      margin: 0 0 10px 0; 
      font-size: 1.1em;
      color: #3474bb;
    }
    #history {
      font-family: 'Courier New', monospace;
      font-size: 0.95em; 
      margin: 0; 
      background: white; 
      border: 1px solid #d0e8f2;
      border-radius: 6px;
      padding: 12px;
      line-height: 1.6;
      max-height: 300px;
      overflow-y: auto;
      color: #333;
    }
    .alert {
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      font-weight: 500;
      display: none;
    }
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .alert.show {
      display: block;
    }
    .credit {
      font-size: 0.9em; 
      color: #7fb6db; 
      text-align: center; 
      margin: 20px 0 0 0;
      padding-top: 15px;
      border-top: 1px solid #e0e8f0;
    }
    input[type="file"] {
      display: none;
    }
    .hidden-file-input {
      display: none;
    }
    @media (max-width: 768px) {
      .container {
        padding: 15px;
        margin: 10px;
      }
      h2 {
        font-size: 1.4em;
      }
      .stats-box {
        gap: 20px;
      }
      .stat-number {
        font-size: 1.4em;
      }
      .header-section {
        flex-direction: column;
        align-items: stretch;
      }
      th, td {
        font-size: 0.9em; 
        padding: 8px 4px;
      }
      .action-buttons {
        justify-content: center;
      }
      .action-buttons button {
        flex: 1;
        min-width: 80px;
      }
      .date-row {
        flex-direction: column;
        align-items: stretch;
      }
      .date-controls {
        flex-direction: column;
      }
      .date-controls select {
        width: 100%;
      }
      .search-box {
        width: 100%;
      }
      .add-row button {
        padding: 10px;
        flex: 1;
      }
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 0;
    }
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background-color: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 90%;
      text-align: center;
    }
    .modal-content h3 {
      margin: 0 0 15px 0;
      color: #3474bb;
    }
    .modal-content button {
      margin: 10px 5px;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95em;
    }
    .modal-content .btn-confirm {
      background: #14cb99;
      color: white;
    }
    .modal-content .btn-cancel {
      background: #bbb;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìã ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h2>
    
    <div id="alertBox" class="alert"></div>

    <div class="header-section">
      <div class="stats-box">
        <div class="stat-item">
          <div class="stat-number" id="totalStudents">0</div>
          <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="totalPresent">0</div>
          <div class="stat-label">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="presentPercentage">0%</div>
          <div class="stat-label">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="totalAbsent">0</div>
          <div class="stat-label">‡∏Ç‡∏≤‡∏î/‡∏•‡∏≤</div>
        </div>
      </div>
    </div>

    <div class="add-row">
      <input id="studentName" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." autofocus autocomplete="off">
      <button onclick="addStudent()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠</button>
    </div>

    <div class="action-buttons">
      <button class="btn-export" onclick="exportToCSV()">üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
      <button class="btn-import" onclick="triggerFileInput()">üì§ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV</button>
      <button class="btn-backup" onclick="backupData()">üíæ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button class="btn-reset" onclick="confirmReset()">üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <input type="file" id="fileInput" accept=".csv" onchange="importFromCSV(event)" class="hidden-file-input">

    <div class="date-row">
      <div class="date-controls">
        <label for="dateSelect">üìÖ ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
        <select id="dateSelect" onchange="changeDay()"></select>
        <button onclick="setToday()" style="background: #3faee4; color: white; border: none; border-radius: 8px; padding: 8px 16px; cursor: pointer; font-weight: 600;">üìå ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
      </div>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." onkeyup="searchStudents()">
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>‡∏ó‡∏µ‡πà</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
            <th title="‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">‚úÖ ‡∏°‡∏≤</th>
            <th title="‡∏°‡∏≤‡∏™‡∏≤‡∏¢">‚è∞ ‡∏°‡∏≤‡∏™‡∏≤‡∏¢</th>
            <th title="‡∏•‡∏≤‡∏Å‡∏¥‡∏à">üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</th>
            <th title="‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢">üè• ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</th>
            <th>‡πÄ‡∏ß‡∏•‡∏≤/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏•‡∏ö</th>
          </tr>
        </thead>
        <tbody id="studentTable"></tbody>
      </table>
    </div>

    <div class="history-block">
      <h4>üìä ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h4>
      <pre id="history"></pre>
    </div>

    <div class="credit">GitHub Copilot Chat Assistant | ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 2.0</div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
      <p id="modalMessage">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
      <button class="btn-confirm" onclick="confirmAction()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      <button class="btn-cancel" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>

  <script>
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    let pendingAction = null;

    function todayStr() {
      const now = new Date();
      return now.toISOString().slice(0, 10);
    }

    function getNowFull() {
      const now = new Date();
      return now.toLocaleString('th-TH', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function showAlert(message, type = 'success') {
      const alertBox = document.getElementById('alertBox');
      alertBox.textContent = message;
      alertBox.className = `alert alert-${type} show`;
      setTimeout(() => {
        alertBox.classList.remove('show');
      }, 3000);
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å localStorage
    let students = JSON.parse(localStorage.getItem("students") || "[]");
    let attendance = JSON.parse(localStorage.getItem("attendance_v4") || "{}");
    let workingDate = todayStr();

    function updateDateSelect() {
      let dateSelect = document.getElementById("dateSelect");
      let allDays = Object.keys(attendance);
      if (allDays.length === 0) allDays.push(todayStr());
      dateSelect.innerHTML = '';
      allDays.sort().reverse().forEach(d => {
        let show = d.split('-').reverse().join('/');
        dateSelect.innerHTML += `<option value="${d}" ${d === workingDate ? 'selected' : ''}>${show}</option>`;
      });
    }

    function setToday() {
      workingDate = todayStr();
      if (!attendance[workingDate]) attendance[workingDate] = {};
      updateDateSelect();
      renderTable();
      showHistory();
    }

    function changeDay() {
      let chosen = document.getElementById("dateSelect").value;
      workingDate = chosen;
      renderTable();
      showHistory();
    }

    function addStudent() {
      let n = document.getElementById('studentName').value.trim();
      if (!n) {
        showAlert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'warning');
        return;
      }
      if (students.includes(n)) {
        showAlert('‚ö†Ô∏è ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'warning');
        return;
      }
      students.push(n);
      students.sort();
      localStorage.setItem("students", JSON.stringify(students));
      document.getElementById('studentName').value = "";
      renderTable();
      showHistory();
      showAlert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    function deleteStudent(idx) {
      pendingAction = () => {
        let name = students[idx];
        students.splice(idx, 1);
        localStorage.setItem("students", JSON.stringify(students));
        Object.keys(attendance).forEach(date => {
          if (attendance[date][name]) delete attendance[date][name];
        });
        localStorage.setItem("attendance_v4", JSON.stringify(attendance));
        renderTable();
        showHistory();
        showAlert(`‚úÖ ‡∏•‡∏ö "${name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
      };
      showConfirmModal(`‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô "${students[idx]}"`, `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${students[idx]}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
    }

    function searchStudents() {
      let searchValue = document.getElementById('searchInput').value.toLowerCase();
      let rows = document.querySelectorAll('#studentTable tr');
      rows.forEach(row => {
        let studentName = row.cells[1]?.textContent.toLowerCase() || '';
        row.style.display = studentName.includes(searchValue) ? '' : 'none';
      });
    }

    function updateStatistics() {
      let at = attendance[workingDate] || {};
      let present = 0;
      students.forEach(name => {
        if (at[name] && (at[name].status === "‡∏°‡∏≤" || at[name].status === "‡∏°‡∏≤‡∏™‡∏≤‡∏¢")) {
          present++;
        }
      });
      let total = students.length;
      let percentage = total > 0 ? Math.round((present / total) * 100) : 0;
      let absent = total - present;

      document.getElementById('totalStudents').textContent = total;
      document.getElementById('totalPresent').textContent = present;
      document.getElementById('presentPercentage').textContent = percentage + '%';
      document.getElementById('totalAbsent').textContent = absent;
    }

    function renderTable() {
      updateDateSelect();
      let at = attendance[workingDate] = attendance[workingDate] || {};
      let tb = "";
      let visibleIndex = 1;
      students.forEach((name, i) => {
        let rec = at[name] || {};
        tb += `<tr>
            <td>${visibleIndex++}</td>
            <td style="text-align: left; padding-left: 15px;">${name}</td>
            <td class="status-radio"><input name="st${i}" type="radio" ${rec.status === "‡∏°‡∏≤" ? "checked" : ""} onclick="mark('${name}','‡∏°‡∏≤')"></td>
            <td class="status-radio"><input name="st${i}" type="radio" ${rec.status === "‡∏°‡∏≤‡∏™‡∏≤‡∏¢" ? "checked" : ""} onclick="mark('${name}','‡∏°‡∏≤‡∏™‡∏≤‡∏¢')"></td>
            <td class="status-radio"><input name="st${i}" type="radio" ${rec.status === "‡∏•‡∏≤‡∏Å‡∏¥‡∏à" ? "checked" : ""} onclick="mark('${name}','‡∏•‡∏≤‡∏Å‡∏¥‡∏à')"></td>
            <td class="status-radio"><input name="st${i}" type="radio" ${rec.status === "‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢" ? "checked" : ""} onclick="mark('${name}','‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢')"></td>
            <td>${
              rec.status === "‡∏°‡∏≤"
                ? `<span class="on-time">‚úÖ ‡∏°‡∏≤<br><small>${rec.time || "-"}</small></span>`
                : rec.status === "‡∏°‡∏≤‡∏™‡∏≤‡∏¢"
                  ? `<span class="late">‚è∞ ‡∏°‡∏≤‡∏™‡∏≤‡∏¢<br><small>${rec.time || "-"}</small></span>`
                  : rec.status === "‡∏•‡∏≤‡∏Å‡∏¥‡∏à"
                    ? `<span class="leave">üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à<br><small>${rec.time || "-"}</small></span>`
                    : rec.status === "‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢"
                      ? `<span class="sick">üè• ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢<br><small>${rec.time || "-"}</small></span>`
                      : `<span class="not-checked">‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ</span>`
            }</td>
            <td><button class="btn-del" onclick="deleteStudent(${i})">‡∏•‡∏ö</button></td>
          </tr>`;
      });
      document.getElementById("studentTable").innerHTML = tb;
      updateStatistics();
    }

    function mark(name, status) {
      let rec = {
        status: status,
        time: getNowFull()
      };
      attendance[workingDate] = attendance[workingDate] || {};
      attendance[workingDate][name] = rec;
      localStorage.setItem("attendance_v4", JSON.stringify(attendance));
      renderTable();
      showHistory();
      showAlert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å "${name}" - ${status}`, 'success');
    }

    function showHistory() {
      let at = attendance[workingDate] = attendance[workingDate] || {};
      let out = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${workingDate.split('-').reverse().join('/')} \n`;
      out += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
      students.forEach((n, i) => {
        let rec = at[n] || {};
        if (rec.status) {
          out += `[${String(i + 1).padStart(2, '0')}] ${n.padEnd(20)} : ${rec.status} (${rec.time})\n`;
        } else {
          out += `[${String(i + 1).padStart(2, '0')}] ${n.padEnd(20)} : ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ\n`;
        }
      });
      out += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
      document.getElementById("history").textContent = out;
    }

    function exportToCSV() {
      let at = attendance[workingDate] || {};
      let csv = "‡∏ó‡∏µ‡πà,‡∏ä‡∏∑‡πà‡∏≠,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞,‡πÄ‡∏ß‡∏•‡∏≤\n";
      students.forEach((name, i) => {
        let rec = at[name] || {};
        let status = rec.status || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ";
        let time = rec.time || "-";
        csv += `${i + 1},"${name}","${status}","${time}"\n`;
      });

      let link = document.createElement('a');
      link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
      link.download = `attendance_${workingDate}.csv`;
      link.click();
      showAlert('‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    function triggerFileInput() {
      document.getElementById('fileInput').click();
    }

    function importFromCSV(event) {
      let file = event.target.files[0];
      if (!file) return;

      let reader = new FileReader();
      reader.onload = function(e) {
        try {
          let csv = e.target.result;
          let lines = csv.split('\n');
          let imported = 0;

          for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            let cols = lines[i].split(',');
            if (cols.length < 2) continue;
            let name = cols[1].replace(/"